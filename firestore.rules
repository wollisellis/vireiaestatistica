rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ========================================
    // REGRAS SEGURAS - BIOESTAT PLATFORM
    // ========================================
    // Vers√£o balanceada entre seguran√ßa e funcionalidade
    // Sistema educacional para avalia√ß√£o nutricional - UNICAMP
    // ========================================

    // ========================================
    // FUN√á√ïES AUXILIARES
    // ========================================

    // Fun√ß√£o para verificar se o usu√°rio est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Fun√ß√£o para verificar email institucional
    function hasInstitutionalEmail() {
      return isAuthenticated() &&
        (request.auth.token.email.matches('.*@dac\\.unicamp\\.br') ||
         request.auth.token.email.matches('.*@unicamp\\.br') ||
         request.auth.token.email.matches('.*@gmail\\.com')); // Para desenvolvimento
    }

    // Fun√ß√£o para verificar se √© o pr√≥prio usu√°rio
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Fun√ß√£o para verificar se √© professor (com fallback para email + documento)
    function isProfessor() {
      return hasInstitutionalEmail() && (
        // Custom claims (quando dispon√≠vel)
        request.auth.token.role == 'professor' ||
        // Fallback: consultar documento do usu√°rio
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'professor') ||
        // Fallback: email espec√≠fico de professores
        request.auth.token.email.matches('.*@unicamp\\.br')
      );
    }

    // Fun√ß√£o para verificar se √© estudante
    function isStudent() {
      return hasInstitutionalEmail() && (
        request.auth.token.role == 'student' ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student') ||
        !request.auth.token.email.matches('.*@unicamp\\.br') // N√£o professores s√£o estudantes
      );
    }

    // ========================================
    // COLE√á√ïES PRINCIPAIS - CONTROLE ESPEC√çFICO
    // ========================================

    // USERS COLLECTION - Perfis de usu√°rios (ACESSO CONTROLADO)
    match /users/{userId} {
      // ‚úÖ Usu√°rios podem ver e editar apenas seus pr√≥prios dados
      allow read, update: if isAuthenticated() && isOwner(userId);
      
      // ‚úÖ Professores podem ver dados de todos os usu√°rios (sem editar)
      allow read: if isProfessor();
      
      // ‚úÖ Permitir cria√ß√£o de conta com valida√ß√£o
      allow create: if hasInstitutionalEmail() && 
        request.resource.data.keys().hasAll(['role', 'email']) &&
        request.resource.data.role in ['professor', 'student'] &&
        request.auth.uid == userId;
    }

    // QUIZ ATTEMPTS - Tentativas de quiz (PROTE√á√ÉO CR√çTICA)
    match /quiz_attempts/{attemptId} {
      // ‚úÖ Estudantes podem apenas criar e ler suas pr√≥prias tentativas
      allow read, create: if isAuthenticated() && 
        request.resource.data.studentId == request.auth.uid;
        
      // ‚úÖ Professores podem ler todas as tentativas (an√°lise)
      allow read: if isProfessor();
      
      // üö´ NINGU√âM pode editar tentativas ap√≥s cria√ß√£o (integridade)
      allow update, delete: if false;
    }

    // UNIFIED SCORES - Sistema de pontua√ß√£o (PROTE√á√ÉO CR√çTICA)
    match /unified_scores/{studentId} {
      // ‚úÖ Estudantes podem apenas ler sua pr√≥pria pontua√ß√£o
      allow read: if isAuthenticated() && isOwner(studentId);
      
      // ‚úÖ Professores podem ler todas as pontua√ß√µes
      allow read: if isProfessor();
      
      // üö´ Apenas sistema pode escrever pontua√ß√µes (via Cloud Functions)
      allow write: if false;
    }

    // CLASSES - Turmas (CONTROLE DE PROFESSOR)
    match /classes/{classId} {
      // ‚úÖ Professores podem ler as turmas onde s√£o o professor
      allow read: if isProfessor();
      
      // ‚úÖ Professores podem gerenciar (criar, editar, deletar) suas pr√≥prias turmas
      allow write, delete: if isProfessor() && 
        resource.data.professorId == request.auth.uid;
        
      // ‚úÖ Professores podem criar turmas
      allow create: if isProfessor() && 
        request.resource.data.professorId == request.auth.uid;
        
      // ‚úÖ Estudantes podem ver turmas onde est√£o matriculados
      allow read: if isStudent() && 
        exists(/databases/$(database)/documents/classStudents/$(classId + '_' + request.auth.uid));
    }

    // CLASS STUDENTS - Matr√≠culas (CONTROLE ESPEC√çFICO)
    match /classStudents/{enrollmentId} {
      // ‚úÖ Professores podem gerenciar matr√≠culas de suas turmas
      allow read, write: if isProfessor();
      
      // ‚úÖ Estudantes podem ver apenas suas pr√≥prias matr√≠culas
      allow read: if isStudent() && 
        resource.data.studentId == request.auth.uid;
        
      // ‚úÖ Permitir cria√ß√£o para sistema de convites
      allow create: if isAuthenticated();
    }

    // MODULES - M√≥dulos educacionais (ACESSO EDUCACIONAL)
    match /modules/{moduleId} {
      // ‚úÖ Todos os usu√°rios autenticados podem ler m√≥dulos
      allow read: if isAuthenticated();
      
      // ‚úÖ Apenas professores podem criar/editar m√≥dulos
      allow write: if isProfessor();
    }

    // STUDENT PROGRESS - Progresso dos estudantes (PROTE√á√ÉO DE DADOS)
    match /student_module_progress/{progressId} {
      // ‚úÖ Estudantes podem ler/escrever apenas seu pr√≥prio progresso
      allow read, write: if isAuthenticated() && 
        (resource.data.studentId == request.auth.uid ||
         progressId.split('_')[0] == request.auth.uid);
         
      // ‚úÖ Professores podem ler todo o progresso
      allow read: if isProfessor();
      
      // ‚úÖ Permitir cria√ß√£o para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() && 
        request.resource.data.studentId == request.auth.uid;
    }

    // RANKINGS - Sistema de classifica√ß√£o (SOMENTE LEITURA)
    match /{rankingCollection}/{rankingId} {
      // ‚úÖ Todos podem ler rankings (motiva√ß√£o)
      allow read: if isAuthenticated() && 
        rankingCollection.matches('.*[Rr]anking.*');
        
      // üö´ Apenas sistema pode escrever rankings
      allow write: if false;
    }

    // NUTRITIONAL DATASETS - Dados brasileiros (ACESSO CONTROLADO)
    match /nutritional_datasets/{datasetId} {
      // ‚úÖ Usu√°rios autenticados podem ler datasets para exerc√≠cios
      allow read: if isAuthenticated();
      
      // ‚úÖ Apenas professores podem adicionar/editar datasets
      allow write: if isProfessor();
    }

    // ANALYTICS - Dados anal√≠ticos (PROFESSORES APENAS)
    match /{analyticsCollection}/{docId} {
      // ‚úÖ Apenas professores podem acessar analytics
      allow read, write: if isProfessor() && 
        analyticsCollection.matches('.*[Aa]nalytics.*');
    }

    // NOTIFICATIONS - Sistema de notifica√ß√µes (CONTROLE PESSOAL)
    match /notifications/{notificationId} {
      // ‚úÖ Usu√°rios podem ler apenas suas pr√≥prias notifica√ß√µes
      allow read: if isAuthenticated() && 
        resource.data.recipientId == request.auth.uid;
        
      // ‚úÖ Professores podem criar notifica√ß√µes
      allow create: if isProfessor();
      
      // ‚úÖ Usu√°rios podem marcar como lidas
      allow update: if isAuthenticated() && 
        resource.data.recipientId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
    }

    // RANDOMIZED QUIZZES - Quizzes aleat√≥rios (ACESSO DO ESTUDANTE)
    match /randomized_quizzes/{quizId} {
      // ‚úÖ Estudantes podem criar e ler seus pr√≥prios quizzes
      allow read, create: if isStudent() && 
        request.resource.data.studentId == request.auth.uid;
        
      // ‚úÖ Professores podem ler todos os quizzes
      allow read: if isProfessor();
    }

    // QUIZ SESSIONS - Sess√µes ativas de quiz (ACESSO DO ESTUDANTE)
    match /quiz_sessions/{sessionId} {
      // ‚úÖ Estudantes podem gerenciar suas pr√≥prias sess√µes
      allow read, write, create, delete: if isStudent() &&
        (request.resource.data.studentId == request.auth.uid ||
         sessionId.split('_')[0] == request.auth.uid);
         
      // ‚úÖ Professores podem ler todas as sess√µes
      allow read: if isProfessor();
    }

    // HEALTH CHECK - Monitoramento do sistema
    match /_health/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ========================================
    // COLE√á√ïES GERAIS - CONTROLE B√ÅSICO
    // ========================================

    // Cole√ß√µes de configura√ß√£o e sistema (PROFESSORES)
    match /{collection}/{document} {
      allow read, write: if isProfessor() && 
        (collection == 'settings' || 
         collection == 'system_health' ||
         collection == 'audit_logs' ||
         collection.matches('.*[Ss]ystem.*'));
    }

    // Cole√ß√µes de estudantes (ACESSO PR√ìPRIO)
    match /{collection}/{document} {
      allow read, write: if isAuthenticated() && 
        (collection.matches('.*[Ss]tudent.*') ||
         collection.matches('.*[Pp]rogress.*') ||
         collection.matches('.*[Aa]ttempt.*')) &&
        (resource.data.studentId == request.auth.uid ||
         resource.data.userId == request.auth.uid ||
         document == request.auth.uid);
    }

    // DELETED CLASSES - Lixeira de turmas (ACESSO DE PROFESSORES)
    match /deleted_classes/{classId} {
      // ‚úÖ Professores podem ver e gerenciar turmas na lixeira
      allow read, write: if isProfessor();
      
      // ‚úÖ Permitir cria√ß√£o quando turma √© exclu√≠da
      allow create: if isProfessor();
    }

    // ========================================
    // REGRA FINAL - BLOQUEIO PADR√ÉO
    // ========================================

    // Bloquear acesso a qualquer outra cole√ß√£o n√£o especificada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}