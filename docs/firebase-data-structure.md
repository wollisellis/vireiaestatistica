# Estrutura de Dados: Site ‚ÜîÔ∏è Firebase

**bioestat-platform** - Documenta√ß√£o t√©cnica da estrutura de dados Firebase

## üìä Vis√£o Geral

Este documento detalha como os dados fluem entre o frontend (p√°gina `/jogos`) e o Firebase Firestore, especificando exatamente onde cada informa√ß√£o √© armazenada e como √© acessada.

## üèóÔ∏è Estrutura do Firebase Firestore

### 1. Cole√ß√£o `users` - Perfis dos Usu√°rios

**Localiza√ß√£o**: `/users/{userId}`

```javascript
// Documento do usu√°rio
{
  uid: "abc123xyz789",              // ID √∫nico do Firebase Auth
  email: "joao.silva@unicamp.br",   // Email institucional
  displayName: "Jo√£o Silva",        // Nome completo (primeira op√ß√£o)
  name: "Jo√£o Silva",               // Nome alternativo (segunda op√ß√£o)
  fullName: "Jo√£o Silva Santos",    // Nome completo alternativo (terceira op√ß√£o)
  role: "student",                  // Papel: "student" | "professor"
  anonymousId: "2847",              // ID an√¥nimo de 4 d√≠gitos (apenas estudantes)
  anonymousIdGeneratedAt: Timestamp,
  createdAt: Timestamp,
  updatedAt: Timestamp,
  lastActivity: Timestamp,
  status: "active",
  institutionId: "unicamp",
  emailVerified: true
}
```

**Como √© usado na p√°gina `/jogos`**:
- **Nome do estudante**: Extrai primeiro nome de `displayName` ‚Üí `name` ‚Üí `fullName`
- **Anonymous ID**: Campo `anonymousId` exibido como `#{anonymousId}`
- **Identifica√ß√£o**: Campo `uid` usado como `userId` em todo o sistema

### 2. Cole√ß√£o `unified_scores` - Sistema de Pontua√ß√£o

**Localiza√ß√£o**: `/unified_scores/{studentId}`

```javascript
// Documento de pontua√ß√£o unificada
{
  studentId: "abc123xyz789",        // Refer√™ncia ao usu√°rio
  userId: "abc123xyz789",           // Alias para compatibilidade
  userName: "Jo√£o",                 // Nome para exibi√ß√£o
  totalScore: 85.5,                 // Pontua√ß√£o total bruta
  normalizedScore: 85.5,            // Pontua√ß√£o normalizada (0-100)
  moduleScores: {                   // Pontua√ß√µes por m√≥dulo
    "module-1": 85.5,
    "module-2": 0,
    "module-3": 0,
    "module-4": 0
  },
  gameScores: {                     // Pontua√ß√µes por jogo (legacy)
    "game-1": 85.5
  },
  achievements: {                   // Conquistas do estudante
    level: "bronze",
    currentStreak: 1,
    longestStreak: 1
  },
  lastActivity: Timestamp,          // √öltima atividade
  streak: 1,                        // Sequ√™ncia atual
  level: 1,                         // N√≠vel alcan√ßado
  completionRate: 25.0,             // Taxa de conclus√£o (0-100)
  classRank: 1,                     // Posi√ß√£o no ranking da turma
  moduleProgress: {                 // Progresso detalhado por m√≥dulo
    "module-1": {
      title: "Indicadores Antropom√©tricos",
      completionPercentage: 100,
      timeSpent: 900000,            // Em milissegundos
      lastActivity: Timestamp,
      averageAttempts: 1.5
    }
  }
}
```

**Como √© usado na p√°gina `/jogos`**:
- **Pontua√ß√£o do ranking**: Campo `normalizedScore` limitado entre 0-100
- **Posi√ß√£o no ranking**: Campo `classRank` calculado dinamicamente
- **Progresso**: Campo `moduleProgress` para exibir conquistas

### 3. Cole√ß√£o `classes` - Turmas

**Localiza√ß√£o**: `/classes/{classId}`

```javascript
// Documento da turma
{
  id: "turma_2025_1_nutricao",      // ID √∫nico da turma
  name: "Nutri√ß√£o 2025.1",          // Nome da turma
  description: "Turma de Avalia√ß√£o Nutricional",
  semester: "1¬∫ Semestre",          // Semestre
  year: "2025",                     // Ano
  inviteCode: "NUTR2025",           // C√≥digo de convite
  professorId: "prof_abc123",       // ID do professor respons√°vel
  professorName: "Prof. Maria Santos", // Nome do professor
  status: "open",                   // Status: "open" | "closed" | "archived"
  maxStudents: 50,                  // Limite de estudantes
  acceptingNewStudents: true,       // Aceita novos estudantes
  studentsCount: 25,                // Quantidade atual de estudantes
  createdAt: Timestamp,
  updatedAt: Timestamp,
  settings: {                       // Configura√ß√µes da turma
    allowLateSubmissions: true,
    showLeaderboard: true,
    enableCollaboration: false
  }
}
```

**Como √© usado na p√°gina `/jogos`**:
- **Informa√ß√µes da turma**: Campos `name`, `professorName`, `semester`, `year`
- **Contador de alunos**: Campo `studentsCount`

### 4. Cole√ß√£o `classStudents` - Matr√≠culas

**Localiza√ß√£o**: `/classStudents/{classId}_{studentId}`

```javascript
// Documento de matr√≠cula
{
  classId: "turma_2025_1_nutricao", // ID da turma
  studentId: "abc123xyz789",        // ID do estudante
  studentName: "Jo√£o Silva",        // Nome do estudante
  studentEmail: "joao@unicamp.br",  // Email do estudante
  enrolledAt: Timestamp,            // Data de matr√≠cula
  status: "active",                 // Status: "active" | "inactive" | "removed"
  role: "student",                  // Sempre "student" nesta cole√ß√£o
  lastActivity: Timestamp,          // √öltima atividade na turma
  notes: "",                        // Notas do professor (opcional)
  source: "invite_code"             // Como se matriculou
}
```

**Como √© usado na p√°gina `/jogos`**:
- **Lista de estudantes**: Para buscar todos os alunos da turma
- **Verifica√ß√£o de matr√≠cula**: Para confirmar se estudante pertence √† turma

### 5. Cole√ß√£o `quiz_attempts` - Tentativas de Quiz

**Localiza√ß√£o**: `/quiz_attempts/{attemptId}`

```javascript
// Documento de tentativa de quiz
{
  studentId: "abc123xyz789",        // ID do estudante
  moduleId: "module-1",             // ID do m√≥dulo
  startedAt: Timestamp,             // In√≠cio da tentativa
  completedAt: Timestamp,           // Conclus√£o da tentativa
  timeSpent: 450000,                // Tempo gasto (milissegundos)
  answers: {                        // Respostas do estudante
    "q1": "A",
    "q2": "B",
    "q3": "C"
  },
  score: 85.5,                      // Pontua√ß√£o bruta
  percentage: 85.5,                 // Porcentagem (0-100)
  passed: true,                     // Se passou (>= 70%)
  totalQuestions: 10,               // Total de quest√µes
  correctAnswers: 8,                // Respostas corretas
  feedback: {                       // Feedback detalhado
    strengths: ["Quest√µes b√°sicas"],
    improvements: ["Quest√µes avan√ßadas"]
  }
}
```

**Como √© usado na p√°gina `/jogos`**:
- **Verificar conclus√£o**: Para saber se m√≥dulo foi completado
- **Exibir estat√≠sticas**: Pontua√ß√£o, tempo, tentativas no modal
- **Fonte prim√°ria**: Para buscar progresso do m√≥dulo

## üîÑ Fluxo de Dados na P√°gina `/jogos`

### 1. Carregamento Inicial

```javascript
// 1. Autentica√ß√£o
useFirebaseAuth() ‚Üí Firebase Auth

// 2. Perfil do usu√°rio
useRBAC() ‚Üí /users/{userId}

// 3. Acesso flex√≠vel
useFlexibleAccess() ‚Üí combina dados de auth + perfil

// 4. Dados dispon√≠veis no componente
const { user, loading, hasAccess, isProfessor } = useFlexibleAccess()
```

### 2. Exibi√ß√£o do Nome e ID

```javascript
// Localiza√ß√£o: src/app/jogos/page.tsx (linhas 475-487)
const displayName = (() => {
  const fullName = user?.displayName || user?.name || user?.fullName
  const firstName = fullName ? fullName.split(' ')[0] : null
  return firstName || 'Aluno'
})()

// Anonymous ID (linhas 493-500)
const anonymousId = user?.anonymousId
// Exibido como: #{anonymousId} (ex: #2847)
```

### 3. Carregamento do Ranking

```javascript
// Localiza√ß√£o: src/components/ranking/ClassRankingPanel.tsx
// 1. Buscar turmas do estudante
const studentClasses = await ProfessorClassService.getStudentClasses(userId)

// 2. Para cada turma, buscar estudantes
const studentsData = await enhancedClassService.getClassStudents(classId)

// 3. Para cada estudante, consolidar dados
const studentProgress = await enhancedClassService.getStudentDetailedProgress(
  studentId, classId
)

// 4. Ordenar por pontua√ß√£o e atribuir posi√ß√µes
const sortedStudents = students
  .sort((a, b) => b.totalScore - a.totalScore)
  .map((student, index) => ({ ...student, position: index + 1 }))
```

### 4. Atualiza√ß√£o de Pontua√ß√£o

```javascript
// Localiza√ß√£o: src/services/unifiedScoringService.ts
// Quando m√≥dulo √© completado:
window.dispatchEvent(new CustomEvent('moduleCompleted', {
  detail: { userId, moduleId, score, percentage, passed }
}))

// Listener na p√°gina:
window.addEventListener('moduleCompleted', (event) => {
  // Atualiza ranking ap√≥s 2-5 segundos
  setTimeout(() => {
    unifiedScoringService.updateStudentRanking(userId)
  }, 2000)
})
```

## üöÄ Fun√ß√µes de Gera√ß√£o de Dados

### Anonymous ID (4 d√≠gitos)

```javascript
// Localiza√ß√£o: src/lib/firebase.ts (linha 362)
export const generateAnonymousId = (): string => {
  // Gera exatamente 4 d√≠gitos (1000-9999)
  const fourDigitNumber = Math.floor(Math.random() * 9000) + 1000
  return `${fourDigitNumber}`
}

// Usado durante cadastro de estudantes:
const anonymousId = role === 'student' ? generateAnonymousId() : undefined
```

## üîê Regras de Seguran√ßa

```javascript
// Localiza√ß√£o: firestore.rules
// Usu√°rios podem ler apenas seus pr√≥prios dados
match /users/{userId} {
  allow read, update: if request.auth.uid == userId;
  allow read: if isProfessor(); // Professores veem todos
}

// Pontua√ß√µes s√£o protegidas
match /unified_scores/{studentId} {
  allow read, write: if request.auth.uid == studentId;
  allow read: if isProfessor();
}

// Tentativas de quiz s√£o imut√°veis ap√≥s cria√ß√£o
match /quiz_attempts/{attemptId} {
  allow read, create: if request.resource.data.studentId == request.auth.uid;
  allow update, delete: if false; // Nunca permitir edi√ß√£o
}
```

## üìä Exemplo de Consulta Completa

Para buscar todos os dados exibidos na p√°gina `/jogos`:

```javascript
// 1. Dados do usu√°rio atual
const userDoc = await getDoc(doc(db, 'users', userId))
const userData = userDoc.data()

// 2. Pontua√ß√£o do usu√°rio
const scoreDoc = await getDoc(doc(db, 'unified_scores', userId))
const scoreData = scoreDoc.data()

// 3. Turmas do usu√°rio
const classesQuery = query(
  collection(db, 'classStudents'),
  where('studentId', '==', userId),
  where('status', '==', 'active')
)
const classesSnapshot = await getDocs(classesQuery)

// 4. Para cada turma, buscar ranking
for (const classDoc of classesSnapshot.docs) {
  const classData = classDoc.data()
  
  // Buscar outros estudantes da turma
  const studentsQuery = query(
    collection(db, 'classStudents'),
    where('classId', '==', classData.classId),
    where('status', '==', 'active')
  )
  const studentsSnapshot = await getDocs(studentsQuery)
  
  // Para cada estudante, buscar pontua√ß√£o
  const rankings = await Promise.all(
    studentsSnapshot.docs.map(async (studentDoc) => {
      const student = studentDoc.data()
      const scoreDoc = await getDoc(doc(db, 'unified_scores', student.studentId))
      const userDoc = await getDoc(doc(db, 'users', student.studentId))
      
      return {
        studentId: student.studentId,
        studentName: userDoc.data()?.displayName || student.studentName,
        anonymousId: userDoc.data()?.anonymousId,
        totalScore: scoreDoc.data()?.normalizedScore || 0
      }
    })
  )
  
  // Ordenar por pontua√ß√£o
  rankings.sort((a, b) => b.totalScore - a.totalScore)
}
```

## üéØ Pontos Importantes

1. **Anonymous ID**: Apenas estudantes t√™m, gerado automaticamente durante cadastro
2. **Pontua√ß√£o**: Sempre normalizada entre 0-100, fonte principal √© `unified_scores`
3. **Ranking**: Calculado dinamicamente, ordenado por `normalizedScore` decrescente
4. **Turmas**: Um estudante pode estar em m√∫ltiplas turmas
5. **Atualiza√ß√£o**: Ranking atualizado automaticamente quando m√≥dulo √© completado
6. **Performance**: Sistema usa cache de 5 minutos no `unifiedScoringService`

## üì± Responsividade dos Dados

A p√°gina `/jogos` adapta a exibi√ß√£o conforme o dispositivo:
- **Desktop**: Ranking expandido (10 estudantes)
- **Tablet**: Ranking m√©dio (8 estudantes)  
- **Mobile**: Ranking compacto (5 estudantes)

Todos os dados v√™m das mesmas fontes Firebase, apenas a apresenta√ß√£o muda.