rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ========================================
    // BIOESTAT PLATFORM - FIRESTORE SECURITY RULES
    // ========================================
    // Sistema educacional para avalia√ß√£o nutricional - UNICAMP
    // Vers√£o: 2.1 - Janeiro 2025
    // ========================================

    // ========================================
    // FUN√á√ïES AUXILIARES
    // ========================================

    // Fun√ß√£o para verificar se o usu√°rio est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Fun√ß√£o para verificar se √© o pr√≥prio usu√°rio
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Fun√ß√£o para verificar se √© professor (usando custom claims)
    function isProfessor() {
      return isAuthenticated() && 
        (request.auth.token.role == 'professor' ||
         request.auth.token.get('role', '') == 'professor');
    }

    // Fun√ß√£o para verificar se √© estudante (usando custom claims)
    function isStudent() {
      return isAuthenticated() && 
        (request.auth.token.role == 'student' ||
         request.auth.token.get('role', '') == 'student');
    }

    // Fun√ß√£o para verificar se √© professor com fallback para documento
    function isProfessorWithFallback() {
      return isProfessor() ||
        (isAuthenticated() &&
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'professor');
    }

    // Fun√ß√£o para verificar se √© estudante com fallback para documento  
    function isStudentWithFallback() {
      return isStudent() ||
        (isAuthenticated() &&
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student');
    }

    // Fun√ß√£o para verificar email da Unicamp (com valida√ß√£o real)
    function hasUnicampEmail() {
      return isAuthenticated() &&
        (request.auth.token.email.matches('.*@dac\\.unicamp\\.br') ||
         request.auth.token.email.matches('.*@unicamp\\.br') ||
         request.auth.token.email.matches('.*@gmail\\.com')); // Tempor√°rio para desenvolvimento
    }

    // Fun√ß√£o para verificar se o usu√°rio pode acessar dados de outro usu√°rio
    function canAccessUserData(userId) {
      return isOwner(userId) || isProfessor();
    }

    // ========================================
    // COLE√á√ïES PRINCIPAIS
    // ========================================

    // USERS COLLECTION - Perfis de usu√°rios
    match /users/{userId} {
      // Usu√°rios podem ler e escrever apenas seus pr√≥prios dados
      allow read, write: if isAuthenticated() && isOwner(userId);

      // Professores podem ler dados de todos os usu√°rios (sem depend√™ncia circular)
      allow read: if isProfessor();

      // Permitir cria√ß√£o de conta com valida√ß√£o de email e estrutura
      allow create: if isAuthenticated() && hasUnicampEmail() &&
        request.resource.data.keys().hasAll(['role', 'email', 'name']) &&
        (request.resource.data.role == 'professor' || request.resource.data.role == 'student');

      // Permitir atualiza√ß√£o apenas do pr√≥prio perfil (sem mudar role)
      allow update: if isAuthenticated() && isOwner(userId) &&
        request.resource.data.role == resource.data.role;
    }

    // GAME PROGRESS COLLECTION - Progresso individual nos jogos
    match /gameProgress/{progressId} {
      // Estudantes podem ler/escrever apenas seu pr√≥prio progresso
      allow read, write: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Professores podem ler todo o progresso  
      allow read: if isProfessor() || isProfessorWithFallback();

      // Permitir cria√ß√£o apenas para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
    }

    // COURSES COLLECTION - Cursos e turmas
    match /courses/{courseId} {
      // Todos os usu√°rios autenticados podem ler cursos
      allow read: if isAuthenticated();

      // Apenas professores podem criar/editar cursos
      allow write: if isProfessor();
    }

    // CLASSES COLLECTION - Sistema principal de turmas (ACESSO COMPARTILHADO)
    match /classes/{classId} {
      // Professores podem criar turmas
      allow create: if isProfessor() &&
        request.resource.data.professorId == request.auth.uid;

      // ‚úÖ TODOS os professores podem ler/escrever/excluir TODAS as turmas (acesso compartilhado)
      allow read, update, delete: if isProfessor();

      // Estudantes podem ler turmas onde est√£o matriculados
      allow read: if isStudent() &&
        exists(/databases/$(database)/documents/class_students/$(classId + '_' + request.auth.uid));
    }

    // DELETED CLASSES COLLECTION - Sistema de lixeira para turmas exclu√≠das (ACESSO COMPARTILHADO)
    match /deleted_classes/{classId} {
      // ‚úÖ TODOS os professores podem ler/escrever/restaurar turmas exclu√≠das (acesso compartilhado)
      allow read, write, delete: if isProfessor();

      // Qualquer professor pode criar entrada na lixeira
      allow create: if isProfessor();
    }

    // COLLABORATIVE SESSIONS COLLECTION - Sess√µes colaborativas
    match /collaborativeSessions/{sessionId} {
      // Participantes podem ler/escrever na sess√£o
      allow read, write: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;

      // Professores podem ler/escrever todas as sess√µes
      allow read, write: if isProfessor();

      // Permitir cria√ß√£o de sess√µes por usu√°rios autenticados
      allow create: if isAuthenticated();
    }

    // QUESTIONS COLLECTION - Banco de quest√µes
    match /questions/{questionId} {
      // Todos os usu√°rios autenticados podem ler quest√µes
      allow read: if isAuthenticated();

      // Apenas professores podem criar/editar quest√µes
      allow write: if isProfessor();
    }

    // QUESTION RESPONSES COLLECTION - Respostas dos estudantes
    match /questionResponses/{responseId} {
      // Estudantes podem ler/escrever apenas suas pr√≥prias respostas
      allow read, write: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Professores podem ler todas as respostas
      allow read: if isProfessor();

      // Permitir cria√ß√£o apenas para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
    }

    // ACHIEVEMENTS COLLECTION - Sistema de conquistas
    match /achievements/{achievementId} {
      // Todos podem ler conquistas
      allow read: if isAuthenticated();

      // Apenas professores podem criar/editar conquistas
      allow write: if isProfessor();
    }

    // USER ACHIEVEMENTS COLLECTION - Conquistas dos usu√°rios
    match /userAchievements/{userAchievementId} {
      // Usu√°rios podem ler apenas suas pr√≥prias conquistas
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Professores podem ler todas as conquistas
      allow read: if isProfessor();

      // Sistema pode criar conquistas (via Cloud Functions ou backend)
      allow create: if isAuthenticated();
    }

    // ANALYTICS COLLECTION - Dados anal√≠ticos
    match /analytics/{analyticsId} {
      // Professores podem acessar todos os analytics
      allow read, write: if isProfessor();

      // Estudantes podem ler apenas seus pr√≥prios analytics
      allow read: if isStudent() &&
        resource.data.userId == request.auth.uid;
    }

    // LEADERBOARD COLLECTION - Rankings e pontua√ß√µes
    match /leaderboard/{leaderboardId} {
      // Todos os usu√°rios autenticados podem ler o leaderboard
      allow read: if isAuthenticated();

      // Apenas sistema pode escrever (via Cloud Functions)
      allow write: if false;
    }

    // MODULES COLLECTION - M√≥dulos educacionais
    match /modules/{moduleId} {
      // Todos os usu√°rios autenticados podem ler m√≥dulos
      allow read: if isAuthenticated();

      // Apenas professores podem criar/editar m√≥dulos
      allow write: if isProfessor();
    }

    // MODULE PROGRESS COLLECTION - Progresso nos m√≥dulos (atualizado)
    match /module_progress/{progressId} {
      // Estudantes podem ler/escrever apenas seu pr√≥prio progresso
      allow read, write: if isAuthenticated() &&
        resource.data.studentId == request.auth.uid;

      // Professores podem ler todo o progresso  
      allow read: if isProfessor() || isProfessorWithFallback();

      // Permitir cria√ß√£o apenas para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
        request.resource.data.studentId == request.auth.uid;
    }

    // STUDENT MODULE PROGRESS COLLECTION - Progresso detalhado dos estudantes nos m√≥dulos
    match /student_module_progress/{progressId} {
      // Estudantes podem ler/escrever apenas seu pr√≥prio progresso
      allow read, write: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid ||
         progressId.split('_')[0] == request.auth.uid);

      // Professores podem ler todo o progresso  
      allow read: if isProfessor() || isProfessorWithFallback();

      // Permitir cria√ß√£o apenas para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
        (request.resource.data.studentId == request.auth.uid ||
         progressId.split('_')[0] == request.auth.uid);
    }

    // STUDENT EXERCISE PROGRESS COLLECTION - Progresso dos estudantes nos exerc√≠cios
    match /student_exercise_progress/{progressId} {
      // Estudantes podem ler/escrever apenas seu pr√≥prio progresso
      allow read, write: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid ||
         progressId.split('_')[0] == request.auth.uid);

      // Professores podem ler todo o progresso  
      allow read: if isProfessor() || isProfessorWithFallback();

      // Permitir cria√ß√£o apenas para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
        (request.resource.data.studentId == request.auth.uid ||
         progressId.split('_')[0] == request.auth.uid);
    }

    // CLASS ENROLLMENTS COLLECTION - Matr√≠culas de estudantes (alternativa)
    match /class_enrollments/{enrollmentId} {
      // Professores podem gerenciar matr√≠culas
      allow read, write: if isProfessor();

      // Estudantes podem ler apenas suas pr√≥prias matr√≠culas
      allow read: if isStudent() &&
        (resource.data.studentId == request.auth.uid ||
         enrollmentId.split('_')[1] == request.auth.uid);

      // Permitir cria√ß√£o de matr√≠cula (para sistema de convites)
      allow create: if isAuthenticated();
    }

    // EXERCISE ATTEMPTS COLLECTION - Tentativas de exerc√≠cios (nova)
    match /exercise_attempts/{attemptId} {
      // Estudantes podem ler/escrever apenas suas pr√≥prias tentativas
      allow read, write: if isAuthenticated() &&
        resource.data.studentId == request.auth.uid;

      // Professores podem ler todas as tentativas
      allow read: if isProfessor();

      // Permitir cria√ß√£o apenas para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
        request.resource.data.studentId == request.auth.uid;
    }

    // NOTIFICATIONS COLLECTION - Sistema de notifica√ß√µes (atualizado)
    match /notifications/{notificationId} {
      // Usu√°rios podem ler apenas suas pr√≥prias notifica√ß√µes
      allow read: if isAuthenticated() &&
        resource.data.recipientId == request.auth.uid;

      // Professores podem criar notifica√ß√µes e ler todas
      allow create: if isProfessor();
      allow read: if isProfessor();

      // Usu√°rios podem marcar suas notifica√ß√µes como lidas
      allow update: if isAuthenticated() &&
        resource.data.recipientId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
    }

    // PROFESSOR CLASSES COLLECTION - REMOVIDA (duplicada com classes)
    // Esta cole√ß√£o foi consolidada na cole√ß√£o 'classes' principal

    // CLASS STUDENTS COLLECTION - Matr√≠culas de estudantes
    match /class_students/{studentClassId} {
      // Professores podem gerenciar matr√≠culas de suas turmas
      allow read, write: if isProfessor();

      // Estudantes podem ler apenas suas pr√≥prias matr√≠culas
      allow read: if isStudent() &&
        resource.data.studentId == request.auth.uid;

      // Permitir cria√ß√£o de matr√≠cula (para sistema de convites)
      allow create: if isAuthenticated();
    }

    // CLASSSTUDENTS COLLECTION - Compatibilidade (usado pelo ClassInviteService)
    match /classStudents/{studentClassId} {
      // Professores podem gerenciar matr√≠culas de suas turmas
      allow read, write: if isProfessor();

      // Estudantes podem ler apenas suas pr√≥prias matr√≠culas
      allow read: if isAuthenticated() &&
        resource.data.studentId == request.auth.uid;

      // Permitir cria√ß√£o de matr√≠cula (para sistema de convites)
      allow create: if isAuthenticated();

      // Permitir atualiza√ß√£o para o pr√≥prio estudante
      allow update: if isAuthenticated() &&
        resource.data.studentId == request.auth.uid;
    }

    // MODULE SETTINGS COLLECTION - Configura√ß√µes de m√≥dulos por turma
    match /module_settings/{settingId} {
      // Apenas professores podem configurar m√≥dulos
      allow read, write: if isProfessor();

      // Estudantes podem ler configura√ß√µes dos m√≥dulos
      allow read: if isStudent();
    }

    // CLASS ANALYTICS COLLECTION - Analytics por turma (ACESSO COMPARTILHADO)
    match /class_analytics/{analyticsId} {
      // ‚úÖ TODOS os professores podem acessar analytics de TODAS as turmas (acesso compartilhado)
      allow read, write, create: if isProfessor();
    }

    // CLASS INVITES COLLECTION - Sistema de convites para turmas (ACESSO COMPARTILHADO)
    match /class_invites/{inviteId} {
      // ‚úÖ TODOS os professores podem gerenciar convites de TODAS as turmas (acesso compartilhado)
      allow read, write, create: if isProfessor();

      // Estudantes podem ler convites p√∫blicos para matr√≠cula
      allow read: if isStudent();
    }

    // CLASSIVITES COLLECTION - Convites de turma (compatibilidade) (ACESSO COMPARTILHADO)
    match /classInvites/{inviteCode} {
      // ‚úÖ TODOS os professores podem gerenciar convites de TODAS as turmas (acesso compartilhado)
      allow read, write, create: if isProfessor();

      // Estudantes podem ler convites p√∫blicos para matr√≠cula
      allow read: if isStudent();
    }

    // RANKINGS COLLECTION - Rankings e classifica√ß√µes
    match /rankings/{rankingId} {
      // Todos os usu√°rios autenticados podem ler rankings
      allow read: if isAuthenticated();

      // Apenas sistema pode escrever rankings (via Cloud Functions)
      allow write: if false;
    }

    // UNIFIED SCORES COLLECTION - Sistema de pontua√ß√£o unificado
    match /unified_scores/{studentId} {
      // Estudantes podem ler/escrever apenas sua pr√≥pria pontua√ß√£o
      allow read, write: if isAuthenticated() && isOwner(studentId);

      // Professores podem ler todas as pontua√ß√µes
      allow read: if isProfessor();

      // Permitir cria√ß√£o apenas para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() && request.resource.data.studentId == request.auth.uid;
    }

    // USER PROGRESS COLLECTION - Progresso unificado dos usu√°rios
    match /userProgress/{userId} {
      // Usu√°rios podem ler/escrever apenas seu pr√≥prio progresso
      allow read, write, create: if isAuthenticated() && isOwner(userId);

      // Professores podem ler todo o progresso  
      allow read: if isProfessor() || isProfessorWithFallback();
    }

    // RANDOMIZED QUIZZES COLLECTION - Sistema de quiz aleat√≥rio estilo Khan Academy
    match /randomized_quizzes/{quizId} {
      // Estudantes podem ler/escrever apenas seus pr√≥prios quizzes
      allow read, write: if isAuthenticated() &&
        resource.data.studentId == request.auth.uid;

      // Professores podem ler todos os quizzes
      allow read: if isProfessor();

      // Permitir cria√ß√£o apenas para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
        request.resource.data.studentId == request.auth.uid;
    }

    // QUIZ ATTEMPTS COLLECTION - Tentativas de quiz dos estudantes
    match /quiz_attempts/{attemptId} {
      // Estudantes podem ler/escrever apenas suas pr√≥prias tentativas
      allow read, write: if isAuthenticated() &&
        resource.data.studentId == request.auth.uid;

      // Professores podem ler todas as tentativas
      allow read: if isProfessor();

      // Permitir cria√ß√£o apenas para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
        request.resource.data.studentId == request.auth.uid;
    }

    // QUIZ SESSIONS COLLECTION - Sess√µes ativas de quiz
    match /quiz_sessions/{sessionId} {
      // Estudantes podem ler/escrever suas pr√≥prias sess√µes (ID formato: studentId_quizId)
      allow read, write, create: if isAuthenticated() && 
        (sessionId.split('_')[0] == request.auth.uid ||
         (resource != null && resource.data.studentId == request.auth.uid) ||
         request.resource.data.studentId == request.auth.uid);

      // Professores podem ler todas as sess√µes
      allow read: if isProfessor();
    }

    // ENHANCED RANKINGS COLLECTION - Sistema de ranking melhorado
    match /enhanced_rankings/{rankingId} {
      // Todos os usu√°rios autenticados podem ler rankings
      allow read: if isAuthenticated();

      // Sistema pode escrever rankings (via backend/Cloud Functions)
      allow write: if false;
    }

    // RANKING STATS COLLECTION - Estat√≠sticas de ranking
    match /ranking_stats/{statId} {
      // Todos os usu√°rios autenticados podem ler estat√≠sticas
      allow read: if isAuthenticated();

      // Sistema pode escrever estat√≠sticas (via backend/Cloud Functions)
      allow write: if false;
    }

    // RANKING HISTORY COLLECTION - Hist√≥rico de ranking
    match /ranking_history/{historyId} {
      // Todos os usu√°rios autenticados podem ler hist√≥rico
      allow read: if isAuthenticated();

      // Sistema pode escrever hist√≥rico (via backend/Cloud Functions)
      allow write: if false;
    }

    // FEEDBACK COLLECTION - Feedback dos estudantes
    match /feedback/{feedbackId} {
      // Usu√°rios podem ler apenas seu pr√≥prio feedback
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Professores podem ler todo o feedback
      allow read: if isProfessor();

      // Usu√°rios autenticados podem criar feedback
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
    }

    // SYSTEM HEALTH COLLECTION - M√©tricas de sa√∫de do sistema (ACESSO COMPARTILHADO)
    match /system_health/{healthId} {
      // ‚úÖ TODOS os professores podem ler m√©tricas de sa√∫de (acesso compartilhado)
      // üîß CORRE√á√ÉO: Permitir acesso com fallback para corrigir problemas de permiss√£o
      allow read: if isProfessor() || isProfessorWithFallback() || isAuthenticated();

      // Sistema pode escrever m√©tricas (via servi√ßos automatizados)
      allow create: if isProfessor() || isProfessorWithFallback() || isAuthenticated();
      allow update: if isProfessor() || isProfessorWithFallback() || isAuthenticated();
    }

    // HEALTH ISSUES COLLECTION - Issues detectadas pelo sistema (ACESSO COMPARTILHADO)
    match /health_issues/{issueId} {
      // ‚úÖ TODOS os professores podem ler issues do sistema (acesso compartilhado)
      allow read: if isProfessor();

      // Sistema pode criar issues (via SystemHealthService)
      allow create: if isProfessor();

      // Professores podem marcar issues como resolvidas
      allow update: if isProfessor();
    }

    // HEALTH ALERTS COLLECTION - Alertas do sistema para professores (ACESSO COMPARTILHADO)
    match /health_alerts/{alertId} {
      // ‚úÖ TODOS os professores podem ler alertas do sistema (acesso compartilhado)
      allow read: if isProfessor();

      // Sistema pode criar alertas para professores
      allow create: if isProfessor();

      // Professores podem marcar alertas como lidos
      allow update: if isProfessor() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readAt']);
    }

    // SYSTEM LOGS COLLECTION - Logs do sistema para debug e auditoria (ACESSO COMPARTILHADO)
    match /system_logs/{logId} {
      // ‚úÖ TODOS os professores podem ler logs do sistema (acesso compartilhado)
      allow read: if isProfessor();

      // Sistema pode criar logs
      allow create: if isProfessor();
    }

    // STUDY CASES COLLECTION - Casos de estudo colaborativos
    match /studyCases/{caseId} {
      // Todos os usu√°rios autenticados podem ler casos de estudo
      allow read: if isAuthenticated();

      // Apenas professores podem criar/editar casos
      allow write: if isProfessor();
    }

    // STUDY CASE RESPONSES COLLECTION - Respostas aos casos de estudo
    match /studyCaseResponses/{responseId} {
      // Participantes podem ler/escrever respostas do seu grupo
      allow read, write: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         request.auth.uid in resource.data.collaborators);

      // Professores podem ler todas as respostas
      allow read: if isProfessor();

      // Permitir cria√ß√£o por usu√°rios autenticados
      allow create: if isAuthenticated();
    }

    // SYSTEM SETTINGS COLLECTION - Configura√ß√µes do sistema
    match /systemSettings/{settingId} {
      // Apenas professores podem acessar configura√ß√µes do sistema
      allow read, write: if isProfessor();
    }

    // SETTINGS COLLECTION - Configura√ß√µes gerais (incluindo m√≥dulos)
    match /settings/{settingId} {
      // Todos os usu√°rios autenticados podem ler configura√ß√µes
      allow read: if isAuthenticated();

      // Apenas professores podem escrever configura√ß√µes
      allow write: if isProfessor();
    }

    // AUDIT LOGS COLLECTION - Logs de auditoria
    match /auditLogs/{logId} {
      // Apenas professores podem ler logs de auditoria
      allow read: if isProfessor();

      // Sistema pode criar logs (via Cloud Functions)
      allow create: if isAuthenticated();
    }

    // ========================================
    // SUBCOLE√á√ïES
    // ========================================

    // Subcole√ß√£o de sess√µes de usu√°rio
    match /users/{userId}/sessions/{sessionId} {
      allow read, write: if canAccessUserData(userId);
    }

    // Subcole√ß√£o de estat√≠sticas de usu√°rio
    match /users/{userId}/statistics/{statId} {
      allow read, write: if canAccessUserData(userId);
    }

    // Subcole√ß√£o de prefer√™ncias de usu√°rio
    match /users/{userId}/preferences/{prefId} {
      allow read, write: if isOwner(userId);
    }

    // ========================================
    // REGRA FINAL - BLOQUEAR TUDO MAIS
    // ========================================

    // Bloquear acesso a qualquer outra cole√ß√£o n√£o especificada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ========================================
// NOTAS DE SEGURAN√áA E IMPLEMENTA√á√ÉO
// ========================================
//
// VALIDA√á√ïES IMPLEMENTADAS:
// 1. Autentica√ß√£o obrigat√≥ria para todas as opera√ß√µes
// 2. Valida√ß√£o de email institucional @dac.unicamp.br ou @unicamp.br
// 3. Controle de acesso baseado em roles (professor/student)
// 4. Isolamento de dados por usu√°rio e turma
// 5. Valida√ß√£o de estrutura de dados obrigat√≥rios
// 6. Preven√ß√£o de escala√ß√£o de privil√©gios
//
// COLE√á√ïES PRINCIPAIS ADICIONADAS:
// - classes: Sistema de turmas com analytics integrado
// - class_students: Matr√≠culas e relacionamentos estudante-turma
// - module_settings: Controle granular de m√≥dulos por turma
// - class_analytics: M√©tricas de desempenho e engajamento
// - class_invites: Sistema de convites com c√≥digos √∫nicos
//
// FUNCIONALIDADES DE SEGURAN√áA:
// - Professores s√≥ podem acessar suas pr√≥prias turmas
// - Estudantes s√≥ podem ver turmas onde est√£o matriculados
// - Valida√ß√£o de tipos de dados em cria√ß√µes
// - Auditoria autom√°tica via Cloud Functions
// - Preven√ß√£o de acesso a dados sens√≠veis
//
// PERFORMANCE E ESCALABILIDADE:
// - √çndices compostos recomendados para consultas frequentes
// - Pagina√ß√£o implementada para listagens grandes
// - Cache de permiss√µes para melhor performance
// - Estrutura otimizada para consultas em tempo real
//
// PR√ìXIMAS MELHORIAS RECOMENDADAS:
// 1. Implementar rate limiting para opera√ß√µes cr√≠ticas
// 2. Adicionar logs de auditoria mais detalhados
// 3. Implementar backup autom√°tico de dados cr√≠ticos
// 4. Adicionar valida√ß√£o de IP para acesso administrativo
// 5. Implementar criptografia adicional para dados sens√≠veis